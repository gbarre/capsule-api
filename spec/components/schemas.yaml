Error:
  type: object
  properties:
    error:
      type: string
    error_description:
      type: string

User:
  type: object
  properties:
    id: # correspond à LDAP nsUniqueId
      type: string
      readOnly: true
      example: 02d3e2a0-a925-4438-8199-2cd726d7b42d
    name:
      type: string
      example: foobar
    public_keys:
      $ref: "./schemas.yaml#/SSHKey"
    role:
      type: string
      enum: [user, admin, superadmin]
      default: user
      description: |
        user:
        - can only sign in and administer owned capsules
        - can grant ownership to users on owned capsules
        - may create capsules depending on platform configuration

        admin:
        - can perform base user actions
        - can create capsules and grant ownership to users on them
        - can also administer all capsules

        superadmin:
        - can perform admin actions
        - can assign admin and superadmin role to users
        - can create runtime models
  readOnly: true

AvailableOpt:
  type: array
  properties:
    access_level:
      type: string
      enum: [user, admin, superadmin]
    tag:
      type: string
    field_name:
      type: string
    field_description:
      type: string
      default: ""
    value_type:
      type: string
      enum: [string, integer, float, boolean, file] # not definitive
    default_value:
      type: string # type corresponding to valueType
      description: type must match valueType
    validation_rules:
      type: array
      default: []
  required:
    - tag
    - field_name
    - value_type
    - access_level
    - default_value
  example:
    - access_level: admin
      tag: SQL
      field_name: my.cnf
      field_description: >-
        Fichier de configuration MySQL
      value_type: file
      default_value: "{base64-encoded my.cnf file content}"
    - access_level: user
      tag: SQL
      field_name: threads
      field_description: >-
        Nombre de threads MySQL
      value_type: integer
      default_value: "20"
      validation_rules:
        - type: min
          arg: "1"
        - type: max
          arg: "200"

Runtime:
  type: object
  properties:
    id:
      type: string
      readOnly: true
      example: a972e936-0840-4278-b5d2-8ec7af8836bc
    name:
      type: string
      example: MariaDB 10.1
    desc:
      type: string
      example: >-
        MySQL Database Server
    fam:
      type: string
      example: Database
    runtime_type:
      type: string
      enum: [webapp, addon]
    uri_template:
      nullable: true
      type: object
      properties:
        pattern:
          type: string
        variables:
          type: array
          items:
            - $ref: "./schemas.yaml#/UriVariables"
      required:
        - pattern
        - variables
      example:
        pattern: "mysql://{username}:{password}@host:port/{username}"
        variables:
          - name: "username"
            src: "capsule" # currently "capsule" or "random"
            length: 16
            unique: true
          - name: password
            src: "random"
            length: 32
            unique: false
    available_opts:
      $ref: "./schemas.yaml#/AvailableOpt"
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - name
    - runtime_type
    - desc
    - fam

UriVariables:
  type: object
  properties:
    name:
      type: string
    src:
      type: string
      enum: [capsule, random]
    length:
      type: integer
    unique:
      type: boolean
  required:
    - name
    - src
    - length
    - unique

Cron:
  type: object
  properties:
    id:
      type: string
      readOnly: true
      example: 9140f660-a8bf-4cca-b4e7-4db336e23d22
    minute:
      type: string
      default: "0"
    hour:
      type: string
      default: "*"
    month_day:
      type: string
      default: "*"
    month:
      type: string
      default: "*"
    week_day:
      type: string
      default: "*"
    command:
      type: string
      example: "/usr/bin/php /app/data/www/admin/cli/cron.php"
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - command

WebApp:
  type: object
  properties:
    id:
      type: string
      readOnly: true
      example: d41ea210-742a-410c-a971-3978143eab80
    tls_redirect_https:
      type: boolean
      default: true
    tls_crt:
      type: string
      writeOnly: true
      example: "Base 64 encoded pem crt"
    tls_key:
      type: string
      format: password
      writeOnly: true
      example: "Base 64 encoded pem key"
    fqdns:
      type: array
      items:
        type: object
        properties:
          name:
            type: string
            format: hostname
            pattern: '^(?!:\/\/)([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-][a-zA-Z0-9-]+\.[a-zA-Z]{2,6}?$'
          alias:
            type: boolean
      example:
        - name: main.fqdn.ac-versailles.fr
          alias: false
        - name: secondary.fqdn.ac-versailles.fr
          alias: true
      description: first FQDN is the main one
    runtime_id:
      type: string
      example: e48e31e2-e271-4a2c-aee4-e73caa8aa615
    env:
      type: object
      description: Dict of environment variables
      example:
        HTTP_PROXY: http://proxy:3128/
        HTTPS_PROXY: https://proxy:3128/
      default: {}
    opts:
      type: array
      items:
        type: object
        properties:
          tag:
            type: string
            example: PHP
          field_name:
            type: string
            example: worker
          value:
            type: string # can be any value
            example: "42"
      default: []
    crons:
      type: array
      items:
        $ref: "./schemas.yaml#/Cron"
      default: []
    quota:
      description: quota obtained from the capsule declaration
      type: object
      properties:
        volume_size:
          type: integer
          #format: GB
          readOnly: true
          example: "20"
        memory_max:
          type: integer
          #format: GB
          readOnly: true
          example: "4"
        cpu_max:
          type: number
          readOnly: true
          example: "2.5"
      readOnly: true
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - fqdns
    - runtime_id

WebAppInVerbose:
  type: object
  properties:
    id:
      type: string
      readOnly: true
      example: d41ea210-742a-410c-a971-3978143eab80
    tls_redirect_https:
      type: boolean
      default: true
    tls_crt:
      type: string
      writeOnly: true
      example: "Base 64 encoded pem crt"
    tls_key:
      type: string
      format: password
      writeOnly: true
      example: "Base 64 encoded pem key"
    fqdns:
      type: array
      items:
        type: object
        properties:
          name:
            type: string
            format: hostname
            pattern: '^(?!:\/\/)([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-][a-zA-Z0-9-]+\.[a-zA-Z]{2,6}?$'
          alias:
            type: boolean
      example:
        - name: main.fqdn.ac-versailles.fr
          alias: false
        - name: secondary.fqdn.ac-versailles.fr
          alias: true
      description: first FQDN is the main one
    runtime_id:
      type: string
      example: e48e31e2-e271-4a2c-aee4-e73caa8aa615
    env:
      type: object
      description: Dict of environment variables
      example:
        HTTP_PROXY: http://proxy:3128/
        HTTPS_PROXY: https://proxy:3128/
      default: {}
    opts:
      type: array
      items:
        type: object
        properties:
          tag:
            type: string
            example: PHP
          field_name:
            type: string
            example: worker
          value:
            type: string # can be any value
            example: "42"
      default: []
    crons:
      type: array
      items:
        $ref: "./schemas.yaml#/Cron"
      default: []
    quota:
      description: quota obtained from the capsule declaration
      type: object
      properties:
        volume_size:
          type: integer
          #format: GB
          readOnly: true
          example: "20"
        memory_max:
          type: integer
          #format: GB
          readOnly: true
          example: "4"
        cpu_max:
          type: number
          readOnly: true
          example: "2.5"
      readOnly: true
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"

AddOn:
  type: object
  properties:
    id:
      type: string
      readOnly: true
      example: e461015b-7820-4693-87d3-3e05cc490006
    name:
      type: string
      example: MySQL-1
    description:
      type: string
      default: ""
      example: >-
        Service de base de données pour ma capsule
    uri:
      type: string
      format: uri
      readOnly: true
      example: "mysql://username:password@host/database"
      nullable: true
    runtime_id:
      type: string
      example: d4541bee-eb0d-472a-9956-6bbfd63442c0
    env:
      type: object
      description: Dict of environment variables
      example:
        HTTP_PROXY: http://proxy:3128/
        HTTPS_PROXY: https://proxy:3128/
      default: {}
    opts:
      type: array
      items:
        type: object
        properties:
          tag:
            type: string
          field_name:
            type: string
          value:
            type: string # can be any value
      default: []
      example: []
    quota:
      description: quota obtained from the capsule declaration
      type: object
      properties:
        volume_size:
          type: integer
          #format: GB
          readOnly: true
          example: "20"
        memory_max:
          type: integer
          #format: GB
          readOnly: true
          example: "4"
        cpu_max:
          type: number
          readOnly: true
          example: "2.5"
      readOnly: true
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - name
    - runtime_id

Capsule:
  type: object
  properties:
    id:
      type: string
      example: 695d0f1a-beb2-4145-828d-0f7f0fcc6696
      readOnly: true
    uid:
      type: integer
      readOnly: true
      example: 5001
    name:
      type: string
      example: lyc-vernes-osny
    owners:
      type: array
      items:
        type: string
      example:
        - jdoe
        - jdoe1
      uniqueItems: true
      minItems: 1
    webapp:
      type: string
      nullable: true
      example: 1ba583fb-9731-48f1-afd8-93f8d514faff
      readOnly: true
    addons:
      type: array
      items:
        type: string
      example:
        - 24236e31-9a9a-42b5-a6fb-2e32f36e054f
        - bee09122-5b09-4f9c-bc20-9e639f1510bb
      readOnly: true
      uniqueItems: true
      default: []
    authorized_keys:
      $ref: "./schemas.yaml#/SSHKey"
      default: []
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - name
    - owners

CapsuleVerbose:
  type: object
  properties:
    id:
      type: string
      example: 695d0f1a-beb2-4145-828d-0f7f0fcc6696
      readOnly: true
    uid:
      type: integer
      readOnly: true
      example: 5001
    name:
      type: string
      example: lyc-vernes-osny
    owners:
      type: array
      items:
        $ref: "./schemas.yaml#/User"
      uniqueItems: true
      minItems: 1
    webapp:
      $ref: "./schemas.yaml#/WebAppInVerbose"
    addons:
      type: array
      items:
        $ref: "./schemas.yaml#/AddOn"
      default: []
    authorized_keys:
      $ref: "./schemas.yaml#/SSHKey"
      default: []
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - name
    - owners

CapsulePost:
  type: object
  properties:
    id:
      type: string
      example: 695d0f1a-beb2-4145-828d-0f7f0fcc6696
      readOnly: true
    name:
      type: string
      example: lyc-vernes-osny
    owners:
      type: array
      items:
        type: string
      example:
        - jdoe
        - jdoe1
      uniqueItems: true
      minItems: 1
    webapp:
      type: string
      nullable: true
      example: 1ba583fb-9731-48f1-afd8-93f8d514faff
      readOnly: true
    addons:
      type: array
      items:
        type: string
      example:
        - 24236e31-9a9a-42b5-a6fb-2e32f36e054f
        - bee09122-5b09-4f9c-bc20-9e639f1510bb
      readOnly: true
      uniqueItems: true
      default: []
    authorized_keys:
      $ref: "./schemas.yaml#/SSHKeyList"
      default: []
    created_at:
      type: string
      format: date-time
      readOnly: true
      example : "2017-07-21T17:32:28Z"
    updated_at:
      type: string
      format: date-time
      readOnly: true
      example : "2020-03-17T15:32:28Z"
  required:
    - name
    - owners

SSHKey:
  type: array
  items:
    type: object
    properties:
      id:
        type: string
        readOnly: true
      public_key:
        type: string
  example:
    - id: 2573ccf6-d2d5-4774-958c-8ef6d64744a1
      public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCt+vNHscC4LbZY/YQP0hcV4QrwRlhqrcuhAvZZERmp\
        NLLOWK4Neaa7ywikVGOOVcY+q3XRHPNZTVkEZhwm0F+/87LJpNhxhZu4BdJ2mfIwx0JS5gRflfeUxxLJ\
        AwLXQZpcO7GRdz/w12EgBohHNbxJyKwL7DSFAnaZ08/tlsjoNRlo1k4NHFf5Xf8K3M1ZlXeSxNV9nlpX\
        tD6tbVVJn18tDCZgSqH64m1+iVb05sB2htifgkBB+fCElRV/v7Eylc5Zu1EMTlrHmeHB3Yf8DpRMkwYH\
        e4j+yDutLvhhZzGmrnNGcD8zZkE1pwKivjwBKee4Bee8NzVR7vMary2GkqY1 john@doe"
    - id: de2f9eac-c8d5-49e6-9fb4-df93b00761d1
      public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCqDWN5ay+bKoNg/+DbugWvLjY6q+ODdelRkZTakj7U\
        Nq+a40Vm+HHRT2tuoB1NxeR87UieJt9IxWiiTasb/Ss+OgcAn5l8kvQvRQe+dp10qbeQHzkrgjpsFj49\
        YDOVKRTrqm5X721TnpqAo2RjqGBeEU+y9REfXPNPMUsni3w/h/BQqJi/e2CRBRdgbi/3bO0Xf0Pt0bc/\
        9jjF6vulqzttdbxowbee8bJlPyz/LnNcTGDdmw2PNQFwe0ZuhHsFzSLX4acM3je0+xcdlq0+Gq8nU5jz\
        /x0SXuXFz9zFHPO3Ivko1VFdBXaqeb8wOluUjmOxJdDcg3Uqswc5Z08KU+9r jane@doe"

SSHKeyList:
  type: array
  items:
    type: string
  example:
    - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCt+vNHscC4LbZY/YQP0hcV4QrwRlhqrcuhAvZZERmp\
        NLLOWK4Neaa7ywikVGOOVcY+q3XRHPNZTVkEZhwm0F+/87LJpNhxhZu4BdJ2mfIwx0JS5gRflfeUxxLJ\
        AwLXQZpcO7GRdz/w12EgBohHNbxJyKwL7DSFAnaZ08/tlsjoNRlo1k4NHFf5Xf8K3M1ZlXeSxNV9nlpX\
        tD6tbVVJn18tDCZgSqH64m1+iVb05sB2htifgkBB+fCElRV/v7Eylc5Zu1EMTlrHmeHB3Yf8DpRMkwYH\
        e4j+yDutLvhhZzGmrnNGcD8zZkE1pwKivjwBKee4Bee8NzVR7vMary2GkqY1 john@doe"
    - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCqDWN5ay+bKoNg/+DbugWvLjY6q+ODdelRkZTakj7U\
        Nq+a40Vm+HHRT2tuoB1NxeR87UieJt9IxWiiTasb/Ss+OgcAn5l8kvQvRQe+dp10qbeQHzkrgjpsFj49\
        YDOVKRTrqm5X721TnpqAo2RjqGBeEU+y9REfXPNPMUsni3w/h/BQqJi/e2CRBRdgbi/3bO0Xf0Pt0bc/\
        9jjF6vulqzttdbxowbee8bJlPyz/LnNcTGDdmw2PNQFwe0ZuhHsFzSLX4acM3je0+xcdlq0+Gq8nU5jz\
        /x0SXuXFz9zFHPO3Ivko1VFdBXaqeb8wOluUjmOxJdDcg3Uqswc5Z08KU+9r jane@doe"

SSHKeyPost:
  type: object
  properties:
    public_key:
      type: string
      example:
        "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCt+vNHscC4LbZY/YQP0hcV4QrwRlhqrcuhAvZZERmp
        NLLOWK4Neaa7ywikVGOOVcY+q3XRHPNZTVkEZhwm0F+/87LJpNhxhZu4BdJ2mfIwx0JS5gRflfeUxxLJ
        AwLXQZpcO7GRdz/w12EgBohHNbxJyKwL7DSFAnaZ08/tlsjoNRlo1k4NHFf5Xf8K3M1ZlXeSxNV9nlpX
        tD6tbVVJn18tDCZgSqH64m1+iVb05sB2htifgkBB+fCElRV/v7Eylc5Zu1EMTlrHmeHB3Yf8DpRMkwYH
        e4j+yDutLvhhZzGmrnNGcD8zZkE1pwKivjwBKee4Bee8NzVR7vMary2GkqY1 john@doe"

AppToken:
  type: object
  properties:
    id:
      type: string
      readOnly: true
      example: b4c75c57-3cf6-4d6c-a5bb-05102151a4c8
    app:
      type: string
      example: My super app
    owner_id:
      type: string
      readOnly: true
      example: ca9ab78c-9326-4518-a4c3-7c69b8984140
    token:
      type: string
      readOnly: true
      example: KDCte1raIV-ItPQf-sf_tapY4q-kLmvlcJ9yUKPlqbo
  required:
    - app

